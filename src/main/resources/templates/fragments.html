<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

<!-- html head-->
<head th:fragment="head">
  <meta charset="UTF-8">
  <title>Jingeore</title>
  <link rel="stylesheet" href="/node_modules/bootstrap/dist/css/bootstrap.min.css"/>
  <link rel="stylesheet" href="/node_modules/@yaireo/tagify/dist/tagify.css"/>
  <link rel="stylesheet" href="/node_modules/font-awesome/css/font-awesome.min.css"/>
  <script src="/node_modules/jquery/dist/jquery.min.js"></script>
  <script src="/node_modules/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
  <script src="/node_modules/jdenticon/dist/jdenticon.min.js"></script>
  <style>
    .container{
      max-width: 100%;
    }

    .tagify-outside{
      border: 0;
      padding: 0;
      margin: 0;
    }
  </style>
</head>

<nav th:fragment="navbar" class="navbar navbar-expand-sm navbar-dark bg-dark">
  <a class="navbar-brand" href="/" th:href="@{/}">
    <!-- <img src="/images/angFlower.png" width="30" height="30"> -->
    <a class="navbar-brand" th:href="@{/}">Logo</a>
  </a>
  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>

  <div class="collapse navbar-collapse" id="navbarSupportedContent">
    <ul class="navbar-nav mr-auto">
      <li class="nav-item">
        <form th:action="@{/search/product}" class="form-inline" method="get">
          <input class="form-control mr-sm-2" name="keyword" type="search" placeholder="상품 검색" aria-label="Search" />
        </form>
      </li>
    </ul>

    <ul class="navbar-nav justify-content-end">
      <li class="nav-item" sec:authorize="!isAuthenticated()">
        <a class="nav-link" href="#" th:href="@{/login}">로그인</a>
      </li>
      <li class="nav-item" sec:authorize="!isAuthenticated()">
        <a class="nav-link" href="#" th:href="@{/sign-up}">가입</a>
      </li>
      <li class="nav-item" sec:authorize="isAuthenticated()">
        <a class="nav-link btn btn-outline-primary"   href="#" th:href="@{/new-product}">
          <i class="fa fa-plus"></i>  판매 상품 등록
        </a>
      </li>
      <li class="nav-item dropdown" sec:authorize="isAuthenticated()">
        <a class="nav-link active dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
          <svg th:if="${#strings.isEmpty(account?.profileImage)}" th:data-jdenticon-value="${account.getNickname()}" width="24" height="24" class="rounded border bg-light"></svg>
        </a>
        <ul class="dropdown-menu" aria-labelledby="navbarDropdown">
          <li><p class="text-center" th:text="${account.getNickname()}">닉네임</p></li>
          <li><a class="dropdown-item text-center" th:href="@{'/profile/' + ${account.getNickname()}}">프로필</a></li>
          <li><a class="dropdown-item text-center" th:href="@{/settings/nickname}">프로필 수정</a></li>
          <li><a class="dropdown-item text-center" th:href="@{/matching-list}">매칭 요청</a></li>
          <li><a class="dropdown-item text-center" th:href="@{/current-matching/buy}">진행중인 매칭</a></li>
          <li><hr class="dropdown-divider"></li>
          <li>
            <form  class="form-inline my-2 my-lg-0" action="#"  th:action="@{/logout}" method="post">
              <button class="dropdown-item text-center" type="submit">로그아웃</button>
            </form>
          </li>
        </ul>
      </li>
    </ul>
  </div>
</nav>

<!-- 프로필 수정 좌측 메뉴바 -->
<div th:fragment="settings-menu (currentMenu)" class="list-group">
  <a href="#" class="list-group-item list-group-item-action" th:classappend="${currentMenu == 'profile'}? active" th:href="@{/settings/nickname}">닉네임 수정</a>
  <a href="#" class="list-group-item list-group-item-action" th:classappend="${currentMenu == 'password'}? active" th:href="@{/settings/password}">패스워드 수정</a>
  <a href="#" class="list-group-item list-group-item-action" th:classappend="${currentMenu == 'zones'}? active" th:href="@{/settings/zones}">지역정보 수정</a>
  <a href="#" class="list-group-item list-group-item-action" th:classappend="${currentMenu == 'profileImage'}? active" th:href="@{/settings/profileImage}">프로필 이미지 수정</a>
</div>

<!-- 리다이랙션 메시지 -->
<div th:fragment="redirect-message" th:if="${message}" class="alert alert-info alert-dismissible fade show mt-3" role="alert">
  <span th:text="${message}">완료</span>
</div>

<!-- 입력값 검증 스크립트 -->
<script th:fragment="validation" type="application/javascript">
  (function () {
    'use strict';
    window.addEventListener('load', function () {
      // Fetch all the forms we want to apply custom Bootstrap validation styles to
      var forms = document.getElementsByClassName('needs-validation');

      // Loop over them and prevent submission
      Array.prototype.filter.call(forms, function (form) {
        form.addEventListener('submit', function (event) {
          if (form.checkValidity() === false) {
            event.preventDefault();
            event.stopPropagation();
          }
          form.classList.add('was-validated')
        }, false)
      })
    }, false)
  }())
</script>

<!-- Ajax 요청시에 csrf 토큰을 설정하는 스크립트 -->
<script type="application/javascript" th:inline="javascript" th:fragment="ajax-csrf-header">
  $(function() {
    var csrfToken = /*[[${_csrf.token}]]*/ null;
    var csrfHeader = /*[[${_csrf.headerName}]]*/ null;
    $(document).ajaxSend(function (e, xhr, options) {
      xhr.setRequestHeader(csrfHeader, csrfToken);
    });
  });
</script>

<!-- 지역 정보 수정 -> tagify 라이브러리 -->
<div th:fragment="update-zones (baseUrl)">
  <script src="/node_modules/@yaireo/tagify/dist/tagify.min.js"></script>
  <script type="application/javascript">
    $(function () {
      function tagRequest(url, zoneName) {
        $.ajax({
          dataType: "json",
          autocomplete: {
            enabled: true,
            rightKey: true,
          },
          contentType: "application/json; charset=utf-8",
          method: "POST",
          url: "[(${baseUrl})]" + url,
          data: JSON.stringify({'zoneName': zoneName})
        }).done(function (data, status) {
          console.log("${data} and status is ${status}");
        });
      }

      function onAdd(e) {
        tagRequest("/add", e.detail.data.value);
      }

      function onRemove(e) {
        tagRequest("/remove", e.detail.data.value);
      }

      var tagInput = document.querySelector("#zones");

      var tagify = new Tagify(tagInput, {
        enforceWhitelist: true,
        whitelist: JSON.parse(document.querySelector("#whitelist").textContent),
        dropdown : {
          enabled: 1, // suggest tags after a single character input
        } // map tags
      });

      tagify.on("add", onAdd);
      tagify.on("remove", onRemove);

      // add a class to Tagify's input element
      tagify.DOM.input.classList.add('form-control');
      // re-place Tagify's input element outside of the  element (tagify.DOM.scope), just before it
      tagify.DOM.scope.parentNode.insertBefore(tagify.DOM.input, tagify.DOM.scope);
    });
  </script>
</div>

<div th:fragment="image-slide (imageNum)">
  <div id="carouselExampleControls" class="carousel slide" data-bs-ride="carousel">
    <div th:if="${imageNum == 2}" class="carousel-inner">
      <div class="carousel-item active">
        <img th:src="${images.get(0)}" class="rounded d-block w-100 h-100" alt="...">
      </div>
      <div class="carousel-item">
        <img th:src="${images.get(1)}" class="rounded d-block w-100 w-100 h-100" alt="...">
      </div>
    </div>
    <div th:if="${imageNum == 3}" class="carousel-inner">
      <div class="carousel-item active">
        <img th:src="${images.get(0)}" class="rounded d-block w-100 h-100" alt="...">
      </div>
      <div class="carousel-item">
        <img th:src="${images.get(1)}" class="rounded d-block w-100 w-100 h-100" alt="...">
      </div>
      <div class="carousel-item">
        <img th:src="${images.get(2)}" class="rounded d-block w-100 w-100 h-100" alt="...">
      </div>
    </div>
    <div th:if="${imageNum == 4}" class="carousel-inner">
      <div class="carousel-item active">
        <img th:src="${images.get(0)}" class="rounded d-block w-100 h-100" alt="...">
      </div>
      <div class="carousel-item">
        <img th:src="${images.get(1)}" class="rounded d-block w-100 w-100 h-100" alt="...">
      </div>
      <div class="carousel-item">
        <img th:src="${images.get(2)}" class="rounded d-block w-100 w-100 h-100" alt="...">
      </div>
      <div class="carousel-item">
        <img th:src="${images.get(3)}" class="rounded d-block w-100 w-100 h-100" alt="...">
      </div>
    </div>
    <div th:if="${imageNum == 5}" class="carousel-inner">
      <div class="carousel-item active">
        <img th:src="${images.get(0)}" class="rounded d-block w-100 h-100" alt="...">
      </div>
      <div class="carousel-item">
        <img th:src="${images.get(1)}" class="rounded d-block w-100 w-100 h-100" alt="...">
      </div>
      <div class="carousel-item">
        <img th:src="${images.get(2)}" class="rounded d-block w-100 w-100 h-100" alt="...">
      </div>
      <div class="carousel-item">
        <img th:src="${images.get(3)}" class="rounded d-block w-100 w-100 h-100" alt="...">
      </div>
      <div class="carousel-item">
        <img th:src="${images.get(4)}" class="rounded d-block w-100 w-100 h-100" alt="...">
      </div>
    </div>
    <button class="carousel-control-prev" type="button" data-bs-target="#carouselExampleControls" data-bs-slide="prev">
      <span class="carousel-control-prev-icon" aria-hidden="true"></span>
      <span class="visually-hidden">Previous</span>
    </button>
    <button class="carousel-control-next" type="button" data-bs-target="#carouselExampleControls" data-bs-slide="next">
      <span class="carousel-control-next-icon" aria-hidden="true"></span>
      <span class="visually-hidden">Next</span>
    </button>
  </div>
</div>

<div th:fragment="cancel-matching">
  <a href="#" data-bs-toggle="modal" data-bs-target="#cancelMatching" class="text-decoration-none">
    <h4 class="text-danger" data-toggle="modal" data-target="#cancelMatching">매칭 취소</h4>
  </a>
  <div class="modal fade" id="cancelMatching" tabindex="-1" role="dialog" aria-labelledby="cancelMatchingLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h4 class="modal-title" id="cancelMatchingLabel">매칭 취소</h4>
        </div>
        <div class="modal-body">
          <span>현재 진행중인 매칭을 취소하시겠습니까?</span><br>
          <span>상대방과 상의하지 않은 일방적인 취소 행위에는 <b>패널티</b>가 부여될 수 있습니다.</span>
        </div>
        <div class="modal-footer">
          <a href="#" data-bs-dismiss="modal" class="text-decoration-none text-dark">취소</a>
          <form th:action="@{'/cancel-matching/' + ${product.getId()} + '/' + ${product.buyer.getId()}}" method="post">
            <button type="submit" class="btn btn-link text-decoration-none text-dark">확인</button>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>


<div th:fragment="current-matching-menu (currentMenu)" class="list-group">
  <a class="list-group-item list-group-item-action" th:classappend="${currentMenu == 'buy'}? active" href="#" th:href="@{/current-matching/buy}">구매</a>
  <a class="list-group-item list-group-item-action" th:classappend="${currentMenu == 'sell'}? active" href="#" th:href="@{/current-matching/sell}">판매</a>
</div>

</html>